<script src="https://code.jquery.com/jquery-2.2.2.js"></script>
<script src="/socket.io.js"></script>
<script>
$(document).ready(function(){
//$.getScript('/chart.js')
$.getScript('/highstock0.js')

$.getScript('https://code.highcharts.com/stock/modules/exporting.js')
  var socket = io();
  var DemoStocks = ["MSFT", "YHOO"];
  dataForChart(DemoStocks);

})



function dataForChart (arrayOfStocks) {
  arrayOfStocks = ["MSFT", "YHOO"]
var seriesToPass = [];
//Add for each here
var rdyToRender = 0
for(i=0;i<arrayOfStocks.length;i++){
    $.getJSON('https://www.quandl.com/api/v3/datasets/YAHOO/'+ arrayOfStocks[i] +'.json?start_date=2015-01-03&order=asc', function (dat,err,xhr) {
       var data =dat.dataset.data;
        // split the data set into ohlc and volume
        var ohlc = [],
            volume = [],
            dataLength = data.length,
            // set the allowed units for data grouping
            groupingUnits = [[
                'week',                         // unit name
                [1]                             // allowed multiples
            ], [
                'month',
                [1, 2, 3, 4, 6]
            ]],

            i = 0;

        for (i; i < dataLength; i += 1) {
            ohlc.push([
                Date.parse(data[i][0]+' UTC'), // the date
                data[i][4] // close
            ]);

            volume.push([
                data[i][0], // the date
                data[i][5] // the volume
            ]);
        }
        rdyToRender++;


        let stockName = JSON.parse(xhr.responseText)
        //stockName = stockName.dataset.dataset_code
                seriesToPass.push("{name:"+ stockName.dataset.dataset_code + ",data:"+ohlc+"}");

        if(rdyToRender == arrayOfStocks.length){
          makeChart(seriesToPass);
          console.log(seriesToPass)
}
})
}







}


function makeChart (arrayToRender){
        $('#container').highcharts('StockChart', {

            rangeSelector: {
                selected: 1
            },

            title: {
                text: 'Historical Daily Closings'
            },

            yAxis: [{
                labels: {
                    align: 'right',
                    x: -3
                },
                title: {
                    text: 'OHLC'
                },
                height: '60%',
                lineWidth: 2
            }, {
                labels: {
                    align: 'right',
                    x: -3
                },
                title: {
                    text: 'Volume'
                },
                top: '65%',
                height: '35%',
                offset: 0,
                lineWidth: 2
            }],

            series: arrayToRender
      //          dataGrouping: {
      //              units: groupingUnits
      //          }

        });
}
</script>
<html>
<head>
  <title>Chart The Stock Market</title>
</head>
<body>

<div id="container" style="height: 400px; min-width: 310px"></div>
<div id="addAndRemove">Add and remove</div>
<body>
<html>
